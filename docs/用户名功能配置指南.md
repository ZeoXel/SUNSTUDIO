# 用户名功能配置指南

本文档说明如何配置用户名自定义功能，包括数据库迁移和后端 API 配置。

## 功能概述

用户可以在用户中心页面自定义用户名，独立于第三方登录返回的 name 字段。

### 前端功能

- ✅ 头像下方显示用户名（优先显示 `username`，回退到 `name`）
- ✅ 点击用户名旁的编辑按钮可修改
- ✅ 支持 Enter 保存、Escape 取消
- ✅ 实时更新显示

## 配置步骤

### 1. 应用数据库迁移

在 USERAPI 网关的数据库中执行迁移文件：

```bash
# 使用 psql 执行
psql -U postgres -d userapi_db -f database/migrations/001_add_username_to_users.sql
```

或者通过 Supabase Dashboard:
1. 打开 SQL Editor
2. 复制 `database/migrations/001_add_username_to_users.sql` 内容
3. 执行

**迁移内容**:
- 在 `users` 表添加 `username` 列（VARCHAR(50)，可为空）
- 添加索引 `idx_users_username`
- 添加字段注释

### 2. 更新后端 API (USERAPI 网关)

后端需要实现以下 API 端点：

#### 2.1 用户名更新 API

```
POST /api/user/update-username
Headers: Authorization: Bearer <api_key>
Content-Type: application/json

Body:
{
  "username": "新用户名"
}

Response:
{
  "success": true,
  "username": "新用户名"
}
```

**验证规则**:
- 用户名不能为空
- 长度：1-50 个字符
- 需要 API Key 认证

#### 2.2 用户信息查询 API 更新

更新 `GET /api/user/me` 返回的用户信息，包含 `username` 字段：

```json
{
  "user": {
    "id": "...",
    "provider": "authing",
    "name": "张三",
    "username": "zhangsan123",  // 新增字段
    "email": "...",
    "phone": "...",
    "avatar": "...",
    "role": "user",
    "status": "active"
  },
  "keys": [...],
  "usage": {...}
}
```

### 3. 验证配置

前端已经实现以下功能，配置后即可使用：

1. **查看用户名**:
   - 打开用户中心
   - 头像下方显示用户名

2. **编辑用户名**:
   - 点击用户名旁的编辑图标
   - 输入新用户名
   - 按 Enter 保存或点击"保存"按钮
   - 按 Escape 或点击"取消"按钮取消编辑

3. **验证更新**:
   - 刷新页面
   - 用户名应保持最新值

## 技术实现细节

### 前端 (已完成)

**文件**: `src/components/studio/UserInfoModal.tsx`

**关键功能**:
```typescript
// 优先使用 username，回退到 name
{userData?.user.username || userData?.user.name || '未设置'}

// 编辑状态管理
const [isEditingUsername, setIsEditingUsername] = useState(false);
const [editedUsername, setEditedUsername] = useState('');

// 保存用户名
const handleSaveUsername = async () => {
  const response = await fetch('/api/user/update-username', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: editedUsername.trim() }),
  });
  // 更新本地状态
};
```

### 类型定义 (已完成)

**文件**: `src/services/userApiService.ts`

```typescript
export interface UserApiUser {
  id: string;
  provider: string;
  name: string;
  username?: string; // 新增：用户自定义用户名
  email: string | null;
  phone: string | null;
  avatar: string | null;
  role: string;
  status: string;
}
```

### 前端 API 路由 (已完成)

**文件**: `src/app/api/user/update-username/route.ts`

- 验证用户名合法性
- 转发请求到 USERAPI 网关
- 处理认证和错误

## 设计考虑

1. **向后兼容**: `username` 为可选字段，不影响现有功能
2. **回退机制**: 如果 `username` 未设置，显示 `name`
3. **验证**: 前后端双重验证用户名格式
4. **性能**: 添加数据库索引优化查询
5. **安全**: 需要 API Key 认证才能更新

## UI 布局优化 (已完成)

### 账户管理页面布局

- **左侧** (1/3): 用户信息 + 联系方式 + 使用统计
  - 头像居中
  - 用户名（可编辑）+ 状态标签
  - 邮箱、手机号卡片
  - 30天使用统计（渐变卡片）

- **右侧** (2/3):
  - **API Keys (极简)**: 2列网格，最多显示2个密钥
  - **最近交易**: 上下排布的列表（可滚动）

### 密钥区域设计

- 极简化展示，占用最小空间
- 2列网格布局
- 点击复制密钥
- 显示密钥名称和前缀

### 最近交易设计

- 上下排布，更适合列表数据
- 每条记录显示：服务名称、时间、模型、消耗积分
- 支持滚动查看更多记录

## 故障排查

### 问题：保存用户名失败

**可能原因**:
1. 后端 API 未实现 `/api/user/update-username`
2. 数据库未应用迁移
3. API Key 无效或过期

**解决方法**:
1. 检查后端日志
2. 验证数据库迁移状态
3. 确认 API Key 有效性

### 问题：用户名不显示

**可能原因**:
1. 后端 API 未返回 `username` 字段
2. 用户未设置用户名

**解决方法**:
1. 检查 `/api/user/me` 返回数据
2. 确认数据库中 `username` 列存在

## 后续扩展

可选的增强功能：

1. **用户名唯一性**:
   - 取消注释 SQL 中的 UNIQUE 约束
   - 后端添加重复检查

2. **用户名格式限制**:
   - 只允许字母、数字、下划线
   - 添加前端和后端正则验证

3. **用户名历史**:
   - 记录用户名修改历史
   - 添加修改频率限制

4. **用户名搜索**:
   - 支持按用户名搜索用户
   - 使用已建立的索引提高性能
